<div class="container py-4">
  <div class="page-header-with-back">
    <div class="back-navigation">
      <a routerLink="/playlists" class="btn-back">Volver a playlists</a>
    </div>
    <div class="header-content">
      <h1>{{ playlist()?.name || 'Playlist' }}</h1>
      <button class="btn-create" (click)="openAddModal()">Agregar canci√≥n</button>
    </div>
  </div>

  @if (successMessage()) {
    <div class="alert alert-success">
      ‚úì {{ successMessage() }}
    </div>
  }

  @if (errorMessage()) {
    <div class="alert alert-danger">
      ‚ö†Ô∏è {{ errorMessage() }}
    </div>
  }

  @if (isLoading()) {
    <div class="loading-container">
      <span class="loading"></span> Cargando canciones...
    </div>
  } @else if (playlistSongs().length === 0) {
    <div class="empty-state card">
      <span class="empty-icon">üéµ</span>
      <h3>No hay canciones en esta playlist</h3>
      <p>Comienza agregando canciones a tu playlist</p>
      <button class="btn btn-primary" (click)="openAddModal()">Agregar canci√≥n</button>
    </div>
  } @else {
    <div class="table-container card">
      <table class="data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Canci√≥n</th>
            <th>√Ålbum</th>
            <th>G√©nero</th>
            <th>Duraci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (playlistSong of playlistSongs(); track playlistSong.id) {
            <tr>
              <td>{{ playlistSong.orderIndex + 1 }}</td>
              <td>
                <div class="song-info">
                  <span class="song-icon">üéµ</span>
                  <strong>{{ getSongTitle(playlistSong) }}</strong>
                </div>
              </td>
              <td>{{ getSongAlbumName(playlistSong) }}</td>
              <td>{{ playlistSong.song?.genreName || '-' }}</td>
              <td>{{ getSongDuration(playlistSong) }}</td>
              <td>
                <div class="action-buttons">
                  <button
                    (click)="openDeleteModal(playlistSong)"
                    class="btn-action btn-action-delete"
                    title="Eliminar"
                  >
                    üóëÔ∏è
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }
</div>

<!-- Add Song Modal -->
@if (showAddModal()) {
  <div class="modal-overlay" (click)="closeAddModal()">
    <div class="modal-content modal-large" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Agregar Canci√≥n a Playlist</h3>
        <button class="modal-close" (click)="closeAddModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <form [formGroup]="addSongForm" (ngSubmit)="onAddSong()">
          <div class="form-group">
            <label class="form-label" for="songId">Selecciona una canci√≥n *</label>
            @if (isLoadingSongs()) {
              <div class="loading-select">
                <span class="loading"></span> Cargando canciones...
              </div>
            } @else {
              <select
                id="songId"
                formControlName="songId"
                class="form-input"
                [class.error]="addSongForm.get('songId')?.invalid && addSongForm.get('songId')?.touched"
              >
                <option [value]="null">Selecciona una canci√≥n</option>
                @for (song of availableSongs(); track song.id) {
                  <option [value]="song.id">
                    {{ song.name }} - {{ song.albumName || 'Sin √°lbum' }}
                  </option>
                }
              </select>
              @if (addSongForm.get('songId')?.invalid && addSongForm.get('songId')?.touched) {
                <span class="error-message">Debes seleccionar una canci√≥n</span>
              }
            }
          </div>

          <div class="form-group">
            <label class="form-label" for="orderIndex">Posici√≥n en la playlist *</label>
            <input
              type="number"
              id="orderIndex"
              formControlName="orderIndex"
              class="form-input"
              [class.error]="addSongForm.get('orderIndex')?.invalid && addSongForm.get('orderIndex')?.touched"
              min="0"
            />
            @if (addSongForm.get('orderIndex')?.invalid && addSongForm.get('orderIndex')?.touched) {
              <span class="error-message">
                @if (addSongForm.get('orderIndex')?.errors?.['required']) {
                  La posici√≥n es requerida
                } @else if (addSongForm.get('orderIndex')?.errors?.['min']) {
                  Debe ser un n√∫mero mayor o igual a 0
                }
              </span>
            }
            <p class="help-text">0 es la primera posici√≥n</p>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeAddModal()">Cancelar</button>
        <button class="btn btn-primary" (click)="onAddSong()" [disabled]="isSaving() || addSongForm.invalid">
          @if (isSaving()) {
            <span class="loading"></span> Agregando...
          } @else {
            Agregar Canci√≥n
          }
        </button>
      </div>
    </div>
  </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal()) {
  <div class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Confirmar eliminaci√≥n</h3>
        <button class="modal-close" (click)="closeDeleteModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <p>¬øEst√°s seguro de que deseas eliminar <strong>{{ getSongTitle(selectedPlaylistSong()!) }}</strong> de esta playlist?</p>
        <p class="warning-text">Esta acci√≥n no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
        <button class="btn btn-danger" (click)="confirmDelete()">Eliminar</button>
      </div>
    </div>
  </div>
}
